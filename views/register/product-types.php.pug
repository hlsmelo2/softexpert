extends ../layout/layout.php

block main
    section#register-product-type
        span(v-if="canShowMessage" @click, @mouseover="hideMessage()" class="alert alert-danger") {{ alertMessage }}
        table
            thead
                tr
                    th ID
                    th Name
                    th Description
            tbody
                tr(v-for="(product, index) of list" :key="index")
                    td {{ product.id }}
                    td {{ product.name }}
                    td {{ product.description }}
                
        h1 Product types
        form.wrapper-2(@submit.prevent.cancel="main.killForm()")
            div.line
                label ID
                span#id 0
            div.line
                label Nome
                input(v-model="input.name" type="text" name="name" class="form-control")
            div.line
                label Descrição
                textarea(v-model="input.description" name="description" class="form-control")
            div.line
                label Taxa
                select(v-model="input.tax_id" name="tax_id" class="form-control")
                    option(v-for="(tax, index) of taxesList" :key="index" :value="tax.id") {{ tax.name }}
            div.buttons
                button(@click="register()" class="btn btn-primary") Register

    script.
        main.vue = {
            el: 'section#register-product-type',
            data() {
                return {
                    input: {
                        name: 'Product type name',
                        description: 'Product type description',
                        tax_id: 0,
                    },
                    list: [],
                    taxesList: [],
                    canShowMessage: false,
                    alertMessage: '',
                };
            },
            methods: {
                getList() {
                    const vue = this;
                    const url = main.getApiUrl('product-types');

                    main.getJSONRequest(url, 'GET')
                        .then(function(json) { vue.list = json; });
                },
                fillTaxes() {
                    const vue = this;
                    const url = main.getApiUrl('taxes');

                    main.getJSONRequest(url, 'GET')
                        .then(function(json) {
                            vue.taxesList = json;
                            vue.input.tax_id = main.isFilledArray(json) ? json[0].id : 0;
                        });
                },
                add() {
                    this.list.push( Object.assign({}, this.input) );
                },
                showMessage(message) {
                    this.canShowMessage = true;
                    this.alertMessage = message;
                },
                hideMessage() {
                    this.canShowMessage = false;
                },
                register() {
                    const vue = this;
                    const url = main.getApiUrl('product-type');

                    main.getJSONRequest(url, 'POST', { body: vue.input })
                        .then(function(json) {                            
                            if (json.done) {
                                vue.add();
                            }

                            vue.showMessage(json.message);
                        });
                },
            },
            mounted() {
                this.getList();
                this.fillTaxes();
            },
        };
